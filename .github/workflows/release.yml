name: Release JNI SDK

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  GIT_TERMINAL_PROMPT: 0

jobs:
  build-desktop:
    name: Build Desktop (${{ matrix.display }})
    runs-on: ${{ matrix.runner }}
    env:
      BASH_CMD: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os_tag: linux
            display: Linux
            shell: bash
            needs_msys: false
          - runner: macos-latest
            os_tag: macos
            display: macOS
            shell: bash
            needs_msys: false
          - runner: windows-latest
            os_tag: windows
            display: Windows (MSYS2)
            shell: msys2 {0}
            needs_msys: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git for Cargo [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          git config --global url."https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global credential.helper store
          cat <<EOF > ~/.git-credentials
          https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com
          EOF

      - name: Configure git for Cargo [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global url."https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global credential.helper store
          Set-Content -Path "$env:USERPROFILE\.git-credentials" -Value "https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com"

      - name: Install modern Bash (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bash
          echo "BASH_CMD=$(brew --prefix)/bin/bash" >> "$GITHUB_ENV"

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Determine SDK version
        id: sdk_version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' wrapper-jni/java/build.gradle.kts | head -n 1)
          if [[ -z "${VERSION}" ]]; then
              echo "Unable to determine SDK version" >&2
              exit 1
          fi
          echo "sdk=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up MSYS2
        if: matrix.needs_msys
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          path-type: inherit
          install: >-
            base-devel
            zip
            unzip

      - name: Build SDK (desktop) [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/wrapper-jni"
          "$BASH_CMD" scripts/build_sdk.sh --release jar

      - name: Build SDK (desktop) [Windows]
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/wrapper-jni"
          "$BASH_CMD" scripts/build_sdk.sh --release jar

      - name: Prepare desktop artifact [Unix]
        if: runner.os != 'Windows'
        shell: bash
        env:
          SDK_VERSION: ${{ steps.sdk_version.outputs.sdk }}
          OS_TAG: ${{ matrix.os_tag }}
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          cd "$GITHUB_WORKSPACE/wrapper-jni/dist"
          cp "dianyaapi-jni-${SDK_VERSION}.jar" "$GITHUB_WORKSPACE/artifacts/dianyaapi-jni-${SDK_VERSION}-${OS_TAG}.jar"

      - name: Prepare desktop artifact [Windows]
        if: runner.os == 'Windows'
        shell: msys2 {0}
        env:
          SDK_VERSION: ${{ steps.sdk_version.outputs.sdk }}
          OS_TAG: ${{ matrix.os_tag }}
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          cd "$GITHUB_WORKSPACE/wrapper-jni/dist"
          cp "dianyaapi-jni-${SDK_VERSION}.jar" "$GITHUB_WORKSPACE/artifacts/dianyaapi-jni-${SDK_VERSION}-${OS_TAG}.jar"

      - name: Upload desktop JAR
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.os_tag }}
          path: artifacts/*.jar

  build-android:
    name: Build Android (AAR)
    runs-on: ubuntu-latest
    needs: build-desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git for Cargo
        shell: bash
        run: |
          set -euo pipefail
          git config --global url."https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global credential.helper store
          cat <<EOF > ~/.git-credentials
          https://x-access-token:${{ secrets.DIANYA_TOKEN }}@github.com
          EOF

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Determine SDK version
        id: sdk_version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' wrapper-jni/java/build.gradle.kts | head -n 1)
          if [[ -z "${VERSION}" ]]; then
              echo "Unable to determine SDK version" >&2
              exit 1
          fi
          echo "sdk=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Install Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Add Android targets
        run: rustup target add aarch64-linux-android x86_64-linux-android

      - name: Build SDK (Android)
        env:
          SDK_VERSION: ${{ steps.sdk_version.outputs.sdk }}
        run: |
          set -euo pipefail
          cd wrapper-jni
          bash scripts/build_sdk.sh --release --platform 21 --arch arm64-v8a,x86_64 aar

      - name: Prepare Android artifacts
        env:
          SDK_VERSION: ${{ steps.sdk_version.outputs.sdk }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          cp "wrapper-jni/dist/dianyaapi-jni-${SDK_VERSION}.aar" "artifacts/dianyaapi-jni-${SDK_VERSION}-android.aar"

      - name: Upload Android AAR
        uses: actions/upload-artifact@v4
        with:
          name: aar-android
          path: artifacts/*.aar

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-desktop
      - build-android

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          path: release-assets
          merge-multiple: true

      - name: Verify artifacts
        run: |
          set -euo pipefail
          ls -R release-assets
          jar_count=$(find release-assets -name "*.jar" | wc -l | tr -d ' ')
          aar_count=$(find release-assets -name "*.aar" | wc -l | tr -d ' ')
          if [[ "${jar_count}" -eq 0 ]]; then
            echo "Missing JAR artifacts" >&2
            exit 1
          fi
          if [[ "${aar_count}" -eq 0 ]]; then
            echo "Missing AAR artifacts" >&2
            exit 1
          fi

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**
          name: "dianyaapi-jni-${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body: |
            Automated release for tag '${{ github.ref_name }}'.
            Included assets:
            - Desktop JARs (Linux, macOS, Windows)
            - Android AAR (arm64-v8a, x86_64)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
